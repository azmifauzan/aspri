# ============================================================
# Nginx Reverse Proxy Configuration untuk ASPRI (Laravel + Apache)
#
# Tambahkan blok ini ke dalam server {} block di Nginx Anda,
# atau include file ini dari konfigurasi server Anda.
#
# Masalah yang diatasi: "upstream sent too big header"
# Penyebab: Laravel mengirim header besar (XSRF-TOKEN cookie
# yang di-encrypt + session + header Apache) yang melebihi
# buffer default Nginx (4KB).
# ============================================================

server {
    listen 80;
    listen 443 ssl;
    server_name aspriai.my.id;

    # SSL config (sesuaikan path sertifikat Anda)
    # ssl_certificate /etc/letsencrypt/live/aspriai.my.id/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/aspriai.my.id/privkey.pem;

    # ──────────────────────────────────────────────────────────
    # FIX UTAMA: Perbesar buffer untuk response header upstream
    # Default Nginx terlalu kecil (4k) untuk Laravel app
    # ──────────────────────────────────────────────────────────
    proxy_buffer_size          64k;
    proxy_buffers              64k;
    proxy_busy_buffers_size    64k;
    proxy_read_timeout         300;
    proxy_connect_timeout      300;
    proxy_send_timeout         300;

    # Header forwarding
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Upload size (sesuaikan dengan Laravel config)
    client_max_body_size 20M;

    location / {
        proxy_pass http://172.19.0.3:80;  # sesuaikan IP/port container
    }
}
